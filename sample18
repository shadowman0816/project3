@Component("DeterminePayrollInProgress")
@RequiredArgsConstructor
@Slf4j
public class DeterminePayrollInProgressStep implements Step {

    private final PayrollRepository payrollRepository;
    private final PayrollEventLogRepository eventLogRepository;

    @Transactional
    @Override
    public void execute(WorkflowContext context) {
        String payrollId = (String) context.get("payrollId");
        String eventId = (String) context.get("eventId");

        payrollRepository.findBySrcPayrollId(payrollId).ifPresentOrElse(payroll -> {
            if ("IN_PROGRESS".equalsIgnoreCase(payroll.getStatusCode())) {
                log.info("Payroll is in progress for id: {}", payrollId);

                PayrollEventLog logEntry = new PayrollEventLog();
                logEntry.setSrcEventId(eventId);
                logEntry.setEventName("DeterminePayrollInProgress");
                logEntry.setEventStatus("FAILED");
                logEntry.setErrorDescription("Payroll already in progress.");

                eventLogRepository.save(logEntry);
                context.setStatus("failed");
            } else {
                log.info("Payroll not in progress, proceeding.");
            }
        }, () -> {
            throw new RuntimeException("Payroll not found for id: " + payrollId);
        });
    }
}

